<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brawl Firestars - Ultra Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Inter', sans-serif; }
        canvas { display: block; cursor: crosshair; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); transition: all 0.2s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4); }
        .kill-item { animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        input[type="color"] { border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; background: none; }
    </style>
</head>
<body>

    <!-- UI: Auth Layer -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 p-4">
        <div class="glass p-10 rounded-3xl w-full max-w-md text-white shadow-2xl border border-orange-500/20">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-orange-500/20 rounded-2xl mb-4">
                    <svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h1 class="text-3xl font-black tracking-tighter uppercase">Firestars <span class="text-orange-500 text-sm block tracking-widest">Ultra Edition</span></h1>
                <p class="text-slate-400 text-sm mt-2">Zadaj meno a ovládni bojisko</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Tvoje Meno</label>
                    <input id="auth-username" type="text" placeholder="Napr. ProPlayer" class="w-full p-4 rounded-xl bg-slate-900 border border-slate-800 outline-none focus:border-orange-500 transition text-white">
                </div>
                <div class="pt-2">
                    <button onclick="handleLogin()" class="w-full btn-primary p-4 rounded-xl font-bold shadow-lg text-lg text-white">VSTÚPIŤ DO HRY</button>
                </div>
            </div>
            <p id="auth-msg" class="mt-6 text-sm text-center text-red-400 font-medium"></p>
        </div>
    </div>

    <!-- UI: Main Menu -->
    <div id="menu-screen" class="fixed inset-0 z-40 hidden flex items-center justify-center bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black p-4">
        <div class="glass p-8 md:p-12 rounded-[40px] w-full max-w-4xl text-white shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-orange-500"></div>
            
            <div class="flex flex-col md:flex-row justify-between items-start mb-8 gap-4">
                <div>
                    <h2 class="text-4xl md:text-5xl font-black mb-2">ARENA LOBBY</h2>
                    <p class="text-slate-400">Vitaj, <span id="user-display" class="text-orange-400 font-bold">Hráč</span>. Priprav sa na dlhú bitku.</p>
                </div>
                <div class="text-right glass p-4 rounded-2xl border-orange-500/20">
                    <p class="text-xs uppercase text-slate-500 font-bold">Tvoje Killy</p>
                    <p id="user-kills" class="text-3xl font-black text-orange-500">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Nastavenia Tímu -->
                <div class="space-y-4 p-6 bg-slate-900/50 rounded-3xl border border-white/5">
                    <h3 class="text-xs font-black text-orange-500 uppercase tracking-widest">Nastavenia Tímu</h3>
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex-1">
                            <label class="block mb-2 text-xs font-bold text-slate-500 uppercase">Vyber si Tím</label>
                            <select id="team-select" class="w-full p-3 bg-slate-800 rounded-xl border border-white/10 outline-none">
                                <option value="A">Tím A (Alfa)</option>
                                <option value="B">Tím B (Beta)</option>
                                <option value="C">Tím C (Gama)</option>
                                <option value="D">Tím D (Delta)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 text-xs font-bold text-slate-500 uppercase">Farba</label>
                            <input id="team-color" type="color" value="#3b82f6">
                        </div>
                    </div>
                </div>

                <!-- Nastavenia Arény -->
                <div class="space-y-4 p-6 bg-slate-900/50 rounded-3xl border border-white/5">
                    <h3 class="text-xs font-black text-orange-500 uppercase tracking-widest">Nastavenia Arény</h3>
                    <div>
                        <label class="block mb-2 text-xs font-bold text-slate-500 uppercase">Počet AI v bitke: <span id="enemy-count-val" class="text-white">200</span></label>
                        <input id="enemy-count" type="range" min="4" max="200" step="4" value="200" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-orange-500">
                    </div>
                    <div>
                        <label class="block mb-2 text-xs font-bold text-slate-500 uppercase">Farba nepriateľov</label>
                        <input id="enemy-color" type="color" value="#ef4444">
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="startGame()" class="flex-1 btn-primary p-6 rounded-2xl text-2xl font-black shadow-xl tracking-tight text-white uppercase">Vstúpiť do Arény (8:00)</button>
                <button onclick="handleLogout()" class="px-8 py-4 bg-slate-800 hover:bg-red-900/40 rounded-2xl transition text-slate-400 hover:text-white border border-white/5 font-bold">Odhlásiť</button>
            </div>
        </div>
    </div>

    <!-- UI: Result Screen -->
    <div id="result-screen" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/95 p-4">
        <div class="glass p-12 rounded-[40px] w-full max-w-2xl text-white shadow-2xl text-center border-2 border-orange-500/20">
            <h2 id="result-title" class="text-6xl font-black mb-4">KONIEC BITKY</h2>
            <p id="result-winner" class="text-2xl mb-8 font-bold"></p>
            
            <div id="result-scores" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                <!-- Scores will be injected here -->
            </div>
            
            <button onclick="backToMenu()" class="w-full btn-primary p-6 rounded-2xl text-2xl font-black shadow-lg text-white">SPÄŤ DO LOBBY</button>
        </div>
    </div>

    <!-- UI: HUD -->
    <div id="game-hud" class="fixed inset-0 pointer-events-none hidden">
        <div class="absolute top-6 left-6 flex flex-col gap-4">
            <div class="glass p-5 rounded-2xl text-white shadow-xl min-w-[220px]">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Tvoje Zdravie</span>
                    <span id="hp-text" class="text-sm font-bold">100%</span>
                </div>
                <div class="w-full h-3 bg-slate-900 rounded-full overflow-hidden p-0.5 border border-white/5">
                    <div id="hp-bar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full transition-all duration-300" style="width: 100%"></div>
                </div>
            </div>

            <!-- Score overview -->
            <div id="team-scores-hud" class="flex gap-2 flex-wrap max-w-sm">
                <!-- Teams scores injected here -->
            </div>
        </div>

        <!-- Timer -->
        <div class="absolute top-6 left-1/2 -translate-x-1/2">
            <div class="glass px-10 py-3 rounded-full text-white shadow-2xl border border-orange-500/30">
                <p id="timer-text" class="text-4xl font-black text-center text-orange-500 tabular-nums">08:00</p>
                <p class="text-[9px] text-slate-500 font-bold uppercase text-center tracking-[0.3em]">Arena Time</p>
            </div>
        </div>

        <div id="killfeed" class="absolute top-6 right-6 flex flex-col gap-2 w-72 items-end"></div>

        <!-- OP Autopilot Button -->
        <div class="absolute bottom-10 left-10 pointer-events-auto">
            <button id="auto-btn" onclick="toggleAuto()" class="group relative bg-slate-900/90 hover:bg-slate-800 backdrop-blur-xl border-2 border-orange-500/30 text-white p-5 rounded-3xl font-bold transition-all shadow-2xl flex items-center gap-4">
                <div id="auto-indicator" class="w-5 h-5 rounded-full bg-red-500 shadow-[0_0_20px_rgba(239,68,68,0.7)]"></div>
                <div class="text-left">
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Hack System</p>
                    <p class="text-sm uppercase tracking-tight">OP AUTOPILOT: <span id="auto-status" class="text-red-500">VYPNUTÝ</span></p>
                </div>
            </button>
        </div>

        <div class="absolute bottom-10 right-10 text-white/30 text-xs font-medium uppercase tracking-[0.2em]">
            WASD - Pohyb • Myš - Streľba
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- Configuration & Local Data ---
        const LOCAL_STORAGE_KEY = 'brawlstars_ultra_stats';
        let currentUser = null;
        let userStats = { kills: 0 };
        
        const BOT_NAMES = [
            "Ghost", "Viper", "Ranger", "Bullet", "Shadow", "Falcon", "Titan", "Blaze", 
            "Nova", "Wolf", "Cobra", "Rex", "Slayer", "Eagle", "Striker", "Storm", 
            "Ace", "Hunter", "Flash", "Sniper", "Raven", "Knight", "Frost", "Cyber",
            "Neon", "Pulse", "Havoc", "Static", "Zenith", "Omega", "Rogue", "Blade",
            "Mamba", "Drift", "Aero", "Nitro", "Phantom", "Grizzly", "Hydra", "Volt"
        ];

        const TEAMS = ['A', 'B', 'C', 'D'];
        let teamColors = {
            'A': '#3b82f6',
            'B': '#ef4444',
            'C': '#10b981',
            'D': '#a855f7'
        };

        function loadStats(nickname) {
            const allData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            return allData[nickname] || { kills: 0 };
        }

        function saveStats(nickname, stats) {
            const allData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '{}');
            allData[nickname] = stats;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allData));
        }

        function handleLogin() {
            const nickname = document.getElementById('auth-username').value.trim();
            const msg = document.getElementById('auth-msg');
            if (nickname.length < 2) { msg.innerText = "Zadaj aspoň 2 znaky."; return; }
            currentUser = nickname;
            userStats = loadStats(nickname);
            document.getElementById('user-display').innerText = currentUser;
            document.getElementById('user-kills').innerText = userStats.kills;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
            gameActive = false;
        }

        function backToMenu() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            gameActive = false;
        }

        // --- Game Specs ---
        const MAP_SIZE = 5000;
        const PLAYER_SIZE = 35;
        const PROJECTILE_SPEED = 18;
        const MAX_HP = 100;
        const GRID_SIZE = 150;
        const MATCH_DURATION = 480; // 8 minút

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let gameActive = false;
        let autopilot = false;
        let timeLeft = MATCH_DURATION;
        let lastTimeUpdate = 0;

        const keys = {};
        const mouse = { x: 0, y: 0 };
        const players = [];
        const projectiles = [];
        const particles = [];
        let camera = { x: 0, y: 0 };
        let scores = { 'A': 0, 'B': 0, 'C': 0, 'D': 0 };

        const getDist = (x1, y1, x2, y2) => Math.hypot(x2 - x1, y2 - y1);
        const random = (min, max) => Math.random() * (max - min) + min;

        function addKillFeed(attacker, victim) {
            const feed = document.getElementById('killfeed');
            const item = document.createElement('div');
            
            item.className = `kill-item glass px-4 py-2 rounded-xl text-[11px] text-white flex items-center gap-2 shadow-lg border-l-4`;
            item.style.borderColor = teamColors[attacker.team];
            item.innerHTML = `
                <span class="font-black" style="color: ${teamColors[attacker.team]}">${attacker.name}</span>
                <span class="opacity-40">>></span>
                <span class="font-medium text-slate-300">${victim.name}</span>
            `;
            
            feed.prepend(item);
            setTimeout(() => {
                item.style.opacity = '0';
                item.style.transform = 'translateX(20px)';
                setTimeout(() => item.remove(), 500);
            }, 4000);

            scores[attacker.team]++;
            updateScoresUI();

            if(attacker.isPlayer) {
                userStats.kills++;
                saveStats(currentUser, userStats);
                document.getElementById('user-kills').innerText = userStats.kills;
            }
        }

        function updateScoresUI() {
            const container = document.getElementById('team-scores-hud');
            container.innerHTML = '';
            TEAMS.forEach(t => {
                const div = document.createElement('div');
                div.className = "glass px-3 py-1 rounded-lg flex items-center gap-2 border border-white/5";
                div.innerHTML = `<div class="w-2 h-2 rounded-full" style="background: ${teamColors[t]}"></div><span class="text-[10px] font-black tabular-nums">${scores[t]}</span>`;
                container.appendChild(div);
            });
        }

        function finishGame() {
            gameActive = false;
            document.getElementById('game-hud').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            const resultsDiv = document.getElementById('result-scores');
            resultsDiv.innerHTML = '';
            
            let maxScore = -1;
            let winningTeam = '';

            TEAMS.forEach(t => {
                const p = document.createElement('div');
                p.className = "p-4 rounded-2xl border border-white/10";
                p.style.backgroundColor = teamColors[t] + '22';
                p.innerHTML = `<p class="text-[10px] uppercase font-black mb-1" style="color: ${teamColors[t]}">Tím ${t}</p><p class="text-3xl font-black">${scores[t]}</p>`;
                resultsDiv.appendChild(p);

                if (scores[t] > maxScore) {
                    maxScore = scores[t];
                    winningTeam = t;
                }
            });
            
            const winnerText = document.getElementById('result-winner');
            winnerText.innerText = `Víťazom sa stáva Tím ${winningTeam}!`;
            winnerText.style.color = teamColors[winningTeam];
        }

        class Entity {
            constructor(x, y, team, name, isPlayer = false) {
                this.x = x; this.y = y; this.team = team; this.name = name; this.isPlayer = isPlayer;
                this.hp = MAX_HP; this.radius = PLAYER_SIZE;
                this.speed = isPlayer ? 7.5 : 5.8;
                this.color = teamColors[team];
                this.lastShot = 0; 
                this.shotCooldown = isPlayer ? 400 : (500 + Math.random() * 300);
                this.angle = 0;
            }

            draw() {
                const sx = this.x - camera.x; const sy = this.y - camera.y;
                if (sx < -100 || sx > width + 100 || sy < -100 || sy > height + 100) return;

                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath(); ctx.ellipse(sx, sy + 25, this.radius * 0.8, 12, 0, 0, Math.PI * 2); ctx.fill();

                ctx.save(); ctx.translate(sx, sy);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(10, -10, 5, 0, Math.PI * 2); ctx.arc(10, 10, 5, 0, Math.PI * 2); ctx.fill();
                
                const grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, this.radius);
                grad.addColorStop(0, 'rgba(255,255,255,0.2)'); grad.addColorStop(1, 'rgba(0,0,0,0.1)');
                ctx.fillStyle = grad; ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2; ctx.stroke();
                ctx.restore();

                ctx.fillStyle = 'white'; ctx.font = 'bold 12px Inter, sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(this.name, sx, sy - 55);

                const hpW = 60;
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.roundRect(sx - hpW/2, sy - 48, hpW, 6, 3); ctx.fill();
                ctx.fillStyle = this.hp > 40 ? '#22c55e' : '#ef4444';
                ctx.roundRect(sx - hpW/2, sy - 48, (this.hp/MAX_HP) * hpW, 6, 3); ctx.fill();
            }

            shoot(tx, ty) {
                const now = Date.now();
                const actualCooldown = (this.isPlayer && autopilot) ? 120 : this.shotCooldown;
                if(now - this.lastShot < actualCooldown) return;
                this.lastShot = now;
                const ang = Math.atan2(ty - this.y, tx - this.x);
                this.angle = ang;
                projectiles.push(new Projectile(this.x, this.y, ang, this));
                this.x -= Math.cos(ang) * 4; this.y -= Math.sin(ang) * 4;
                for(let i=0; i<2; i++) particles.push(new Particle(this.x, this.y, 'orange'));
            }
        }

        class Projectile {
            constructor(x, y, angle, owner) {
                this.x = x; this.y = y; this.angle = angle; this.owner = owner;
                this.radius = 11; this.life = 90;
                this.color = owner.color;
            }
            update() {
                this.x += Math.cos(this.angle) * PROJECTILE_SPEED;
                this.y += Math.sin(this.angle) * PROJECTILE_SPEED;
                this.life--;
                if(Math.random() > 0.6) particles.push(new Particle(this.x, this.y, this.color));
            }
            draw() {
                const sx = this.x - camera.x; const sy = this.y - camera.y;
                if (sx < -50 || sx > width + 50 || sy < -50 || sy > height + 50) return;
                ctx.save(); ctx.shadowBlur = 12; ctx.shadowColor = this.color;
                const g = ctx.createRadialGradient(sx, sy, 0, sx, sy, this.radius);
                g.addColorStop(0, 'white'); g.addColorStop(0.5, this.color); g.addColorStop(1, 'transparent');
                ctx.fillStyle = g; ctx.beginPath(); ctx.arc(sx, sy, this.radius, 0, Math.PI * 2); ctx.fill();
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 5; this.vy = (Math.random() - 0.5) * 5;
                this.alpha = 1; this.size = random(2, 4);
            }
            update() { this.x += this.vx; this.y += this.vy; this.alpha -= 0.05; }
            draw() {
                if(this.alpha <= 0) return;
                const sx = this.x - camera.x; const sy = this.y - camera.y;
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(sx, sy, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }

        function startGame() {
            const totalAI = parseInt(document.getElementById('enemy-count').value);
            const userTeam = document.getElementById('team-select').value;
            const enemyColor = document.getElementById('enemy-color').value;
            
            // Set Team Colors
            teamColors[userTeam] = document.getElementById('team-color').value;
            TEAMS.forEach(t => { if(t !== userTeam) teamColors[t] = enemyColor; });

            players.length = 0; projectiles.length = 0; particles.length = 0;
            scores = { 'A': 0, 'B': 0, 'C': 0, 'D': 0 };
            timeLeft = MATCH_DURATION;
            lastTimeUpdate = Date.now();
            updateScoresUI();
            
            // Player
            players.push(new Entity(random(500, MAP_SIZE-500), random(500, MAP_SIZE-500), userTeam, currentUser, true));
            
            // Populate Teams (split totalAI into remaining teams)
            const botPerTeam = Math.floor(totalAI / 4);
            TEAMS.forEach(t => {
                const count = (t === userTeam) ? botPerTeam - 1 : botPerTeam;
                for(let i=0; i<count; i++) {
                    players.push(new Entity(random(0, MAP_SIZE), random(0, MAP_SIZE), t, BOT_NAMES[Math.floor(Math.random()*BOT_NAMES.length)] + " " + (i+1)));
                }
            });

            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            gameActive = true;
            requestAnimationFrame(loop);
        }

        function toggleAuto() {
            autopilot = !autopilot;
            const stat = document.getElementById('auto-status');
            const ind = document.getElementById('auto-indicator');
            if(autopilot) {
                stat.innerText = "ZAPNUTÝ (OP)"; stat.className = "text-green-500 font-black";
                ind.className = "w-5 h-5 rounded-full bg-green-500 shadow-[0_0_20px_rgba(34,197,94,0.7)]";
            } else {
                stat.innerText = "VYPNUTÝ"; stat.className = "text-red-500 font-black";
                ind.className = "w-5 h-5 rounded-full bg-red-500 shadow-[0_0_20px_rgba(239,68,68,0.7)]";
            }
        }

        function loop() {
            if(!gameActive) return;

            const now = Date.now();
            if (now - lastTimeUpdate >= 1000) {
                timeLeft--;
                lastTimeUpdate = now;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timer-text').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) { finishGame(); return; }
            }

            ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, width, height);
            const player = players.find(p => p.isPlayer);
            if(player) {
                camera.x += (player.x - width/2 - camera.x) * 0.1;
                camera.y += (player.y - height/2 - camera.y) * 0.1;
            }

            // Map Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.02)'; ctx.lineWidth = 1;
            for(let x = -camera.x % GRID_SIZE; x < width; x += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke(); }
            for(let y = -camera.y % GRID_SIZE; y < height; y += GRID_SIZE) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke(); }

            // Player logic
            if(player && player.hp > 0) {
                if(autopilot) {
                    // OP Autopilot: Faster speed and aggressive targeting
                    player.speed = 13; 
                    const nearest = players.filter(p => p.team !== player.team && p.hp > 0)
                                           .sort((a,b) => getDist(player.x, player.y, a.x, a.y) - getDist(player.x, player.y, b.x, b.y))[0];
                    if(nearest) {
                        const dist = getDist(player.x, player.y, nearest.x, nearest.y);
                        const ang = Math.atan2(nearest.y - player.y, nearest.x - player.x);
                        if(dist > 250) {
                            player.x += Math.cos(ang) * player.speed; player.y += Math.sin(ang) * player.speed;
                        } else {
                            // Circle around the enemy
                            player.x += Math.cos(ang + Math.PI/2) * player.speed;
                            player.y += Math.sin(ang + Math.PI/2) * player.speed;
                        }
                        player.shoot(nearest.x, nearest.y);
                    }
                } else {
                    player.speed = 7.5;
                    if(keys['w'] || keys['arrowup']) player.y -= player.speed;
                    if(keys['s'] || keys['arrowdown']) player.y += player.speed;
                    if(keys['a'] || keys['arrowleft']) player.x -= player.speed;
                    if(keys['d'] || keys['arrowright']) player.x += player.speed;
                    player.angle = Math.atan2(mouse.y + camera.y - player.y, mouse.x + camera.x - player.x);
                }
                player.x = Math.max(0, Math.min(MAP_SIZE, player.x));
                player.y = Math.max(0, Math.min(MAP_SIZE, player.y));
                document.getElementById('hp-bar').style.width = player.hp + '%';
                document.getElementById('hp-text').innerText = Math.ceil(player.hp) + '%';
            }

            // AI Logic
            players.forEach(p => {
                if(p.hp <= 0) { if(Math.random() < 0.005) { p.hp = MAX_HP; p.x = random(0, MAP_SIZE); p.y = random(0, MAP_SIZE); } return; }
                if(!p.isPlayer) {
                    const enemies = players.filter(e => e.team !== p.team && e.hp > 0);
                    const target = enemies.sort((a,b) => getDist(p.x, p.y, a.x, a.y) - getDist(p.x, p.y, b.x, b.y))[0];
                    if(target) {
                        const d = getDist(p.x, p.y, target.x, target.y);
                        if(d < 1200) {
                            const a = Math.atan2(target.y - p.y, target.x - p.x);
                            p.angle = a;
                            if(d > 300) { p.x += Math.cos(a) * p.speed * 0.8; p.y += Math.sin(a) * p.speed * 0.8; }
                            p.shoot(target.x, target.y);
                        }
                    }
                }
                p.draw();
            });

            // Projectiles
            for(let i = projectiles.length - 1; i >= 0; i--) {
                const prj = projectiles[i]; prj.update(); prj.draw();
                if(prj.life <= 0) { projectiles.splice(i, 1); continue; }
                for(let p of players) {
                    if(p.team !== prj.owner.team && p.hp > 0) {
                        if(getDist(prj.x, prj.y, p.x, p.y) < p.radius + prj.radius) {
                            p.hp -= 15; projectiles.splice(i, 1);
                            for(let k=0; k<4; k++) particles.push(new Particle(prj.x, prj.y, 'white'));
                            if(p.hp <= 0) addKillFeed(prj.owner, p); break;
                        }
                    }
                }
            }

            for(let i = particles.length - 1; i >= 0; i--) { particles[i].update(); particles[i].draw(); if(particles[i].alpha <= 0) particles.splice(i, 1); }
            ctx.strokeStyle = 'rgba(249, 115, 22, 0.4)'; ctx.lineWidth = 20; ctx.strokeRect(-camera.x, -camera.y, MAP_SIZE, MAP_SIZE);
            requestAnimationFrame(loop);
        }

        window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener('mousedown', () => {
            const p = players.find(p => p.isPlayer);
            if(p && p.hp > 0 && !autopilot) p.shoot(mouse.x + camera.x, mouse.y + camera.y);
        });
        window.addEventListener('resize', resize);
        document.getElementById('enemy-count').oninput = (e) => document.getElementById('enemy-count-val').innerText = e.target.value;
        window.onload = resize;

    </script>
</body>
</html>

